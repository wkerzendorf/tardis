<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tardis.plasma.base &mdash; tardis</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/plot_directive.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/tardis_logo.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href="../../../_static/tardis.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> tardis
          </a>
              <div class="version">
                latest
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quickstart for TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Input/Output</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../io/configuration/index.html">Configuration (Required Input)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io/optional/index.html">Optional Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io/visualization/index.html">Visualization Tools &amp; Widgets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io/output/index.html">Additional Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io/grid/TardisGridTutorial.html">Running TARDIS Model Grids</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics Walkthrough</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../physics/setup/index.html">Setting Up the Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../physics/montecarlo/index.html">Monte Carlo Iteration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../physics/est_and_conv/index.html">Estimators and Convergence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../physics/spectrum/index.html">Spectrum Generation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to TARDIS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/CONTRIBUTING.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/development/index.html">Developer Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/CHANGELOG.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/roadmap.html">Development Roadmap</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../resources/credits.html">Credits &amp; Publication Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../resources/research_done_using_TARDIS/research_papers.html">Papers Using TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../resources/code_comparison/index.html">Code Comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../resources/zreferences.html">References and Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Outdated</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../outdated/index.html">Outdated Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">tardis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>tardis.plasma.base</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tardis.plasma.base</h1><div class="highlight"><pre>
<span></span>import os
import re
import logging
import tempfile
import fileinput

import networkx as nx

from tardis.plasma.exceptions import PlasmaMissingModule, NotInitializedModule
from tardis.plasma.properties.base import *
from tardis.io.util import PlasmaWriterMixin

logger = logging.getLogger(__name__)


<div class="viewcode-block" id="BasePlasma"><a class="viewcode-back" href="../../../api/tardis.plasma.base.html#tardis.plasma.base.BasePlasma">[docs]</a>class BasePlasma(PlasmaWriterMixin):

    outputs_dict = {}
    hdf_name = &quot;plasma&quot;

    def __init__(self, plasma_properties, property_kwargs=None, **kwargs):
        self.outputs_dict = {}
        self.input_properties = []
        self.plasma_properties = self._init_properties(
            plasma_properties, property_kwargs, **kwargs
        )
        self._build_graph()
        self.update(**kwargs)

    def __getattr__(self, item):
        if item in self.outputs_dict:
            return self.get_value(item)
        else:
            super(BasePlasma, self).__getattribute__(item)

    def __setattr__(self, key, value):
        if key != &quot;module_dict&quot; and key in self.outputs_dict:
            raise AttributeError(
                &quot;Plasma inputs can only be updated using &quot; &quot;the &#39;update&#39; method&quot;
            )
        else:
            super(BasePlasma, self).__setattr__(key, value)

    def __dir__(self):
        attrs = [item for item in self.__dict__ if not item.startswith(&quot;_&quot;)]
        attrs += [
            item for item in self.__class__.__dict__ if not item.startswith(&quot;_&quot;)
        ]
        attrs += self.outputs_dict.keys()
        return attrs

    @property
    def plasma_properties_dict(self):
        return {item.name: item for item in self.plasma_properties}

<div class="viewcode-block" id="BasePlasma.get_value"><a class="viewcode-back" href="../../../api/tardis.plasma.base.html#tardis.plasma.base.BasePlasma.get_value">[docs]</a>    def get_value(self, item):
        return getattr(self.outputs_dict[item], item)</div>

    def _build_graph(self):
        &quot;&quot;&quot;
        Builds the directed Graph using network X

        :param plasma_modules:
        :return:
        &quot;&quot;&quot;

        self.graph = nx.DiGraph()
        # Adding all nodes
        self.graph.add_nodes_from(
            [
                (plasma_property.name, {})
                for plasma_property in self.plasma_properties
            ]
        )

        # Flagging all input modules
        self.input_properties = [
            item
            for item in self.plasma_properties
            if not hasattr(item, &quot;inputs&quot;)
        ]

        for plasma_property in self.plasma_properties:
            # Skipping any module that is an input module
            if plasma_property in self.input_properties:
                continue

            for input in plasma_property.inputs:
                if input not in self.outputs_dict:
                    raise PlasmaMissingModule(
                        f&quot;Module {plasma_property.name} requires input &quot;
                        f&quot;{input} which has not been added&quot;
                        f&quot; to this plasma&quot;
                    )
                try:
                    position = self.outputs_dict[input].outputs.index(input)
                    label = self.outputs_dict[input].latex_name[position]
                    label = &quot;$&quot; + label + &quot;$&quot;
                    label = label.replace(&quot;\\&quot;, &quot;\\\\&quot;)
                except:
                    label = input.replace(&quot;_&quot;, &quot;-&quot;)
                self.graph.add_edge(
                    self.outputs_dict[input].name,
                    plasma_property.name,
                    label=label,
                )

    def _init_properties(
        self, plasma_properties, property_kwargs=None, **kwargs
    ):
        &quot;&quot;&quot;
        Builds a dictionary with the plasma module names as keys

        Parameters
        ----------
        plasma_modules : list
            list of Plasma properties
        property_kwargs : dict
            dict of plasma module : kwargs pairs. kwargs should be a dict
            of arguments that will be passed to the __init__ method of
            the respective plasma module.
        kwargs : dictionary
            input values for input properties. For example,
            t_rad=[5000, 6000,], j_blues=[..]
        &quot;&quot;&quot;
        if property_kwargs is None:
            property_kwargs = {}
        plasma_property_objects = []
        self.previous_iteration_properties = []
        self.outputs_dict = {}
        for plasma_property in plasma_properties:

            if issubclass(plasma_property, PreviousIterationProperty):
                current_property_object = plasma_property(
                    **property_kwargs.get(plasma_property, {})
                )
                current_property_object.set_initial_value(kwargs)
                self.previous_iteration_properties.append(
                    current_property_object
                )

            elif issubclass(plasma_property, Input):
                if not set(kwargs.keys()).issuperset(plasma_property.outputs):
                    missing_input_values = set(plasma_property.outputs) - set(
                        kwargs.keys()
                    )
                    raise NotInitializedModule(
                        f&quot;Input {missing_input_values} required for &quot;
                        f&quot;plasma but not given when &quot;
                        f&quot;instantiating the &quot;
                        f&quot;plasma&quot;
                    )
                current_property_object = plasma_property(
                    **property_kwargs.get(plasma_property, {})
                )
            else:
                current_property_object = plasma_property(
                    self, **property_kwargs.get(plasma_property, {})
                )
            for output in plasma_property.outputs:
                self.outputs_dict[output] = current_property_object
                plasma_property_objects.append(current_property_object)
        return plasma_property_objects

<div class="viewcode-block" id="BasePlasma.store_previous_properties"><a class="viewcode-back" href="../../../api/tardis.plasma.base.html#tardis.plasma.base.BasePlasma.store_previous_properties">[docs]</a>    def store_previous_properties(self):
        for property in self.previous_iteration_properties:
            p = property.outputs[0]
            self.outputs_dict[p].set_value(
                self.get_value(re.sub(r&quot;^previous_&quot;, &quot;&quot;, p))
            )</div>

<div class="viewcode-block" id="BasePlasma.update"><a class="viewcode-back" href="../../../api/tardis.plasma.base.html#tardis.plasma.base.BasePlasma.update">[docs]</a>    def update(self, **kwargs):
        for key in kwargs:
            if key not in self.outputs_dict:
                raise PlasmaMissingModule(
                    f&quot;Trying to update property {key}&quot; f&quot; that is unavailable&quot;
                )
            self.outputs_dict[key].set_value(kwargs[key])

        for module_name in self._resolve_update_list(kwargs.keys()):
            self.plasma_properties_dict[module_name].update()</div>

<div class="viewcode-block" id="BasePlasma.freeze"><a class="viewcode-back" href="../../../api/tardis.plasma.base.html#tardis.plasma.base.BasePlasma.freeze">[docs]</a>    def freeze(self, *args):
        &quot;&quot;&quot;
        Freeze plama properties.

        This method freezes plasma properties to prevent them from being
        updated: the values of a frozen property are fixed in the plasma
        calculation. This is useful for example for setting up test cases.

        Parameters
        ----------
        args : iterable of str
            Names of plasma properties to freeze.

        Examples
        --------
        &gt;&gt;&gt; plasma.freeze(&#39;t_electrons&#39;)
        &quot;&quot;&quot;
        for key in args:
            if key not in self.outputs_dict:
                raise PlasmaMissingModule(
                    &quot;Trying to freeze property {0}&quot;
                    &quot; that is unavailable&quot;.format(key)
                )
            self.outputs_dict[key].frozen = True</div>

<div class="viewcode-block" id="BasePlasma.thaw"><a class="viewcode-back" href="../../../api/tardis.plasma.base.html#tardis.plasma.base.BasePlasma.thaw">[docs]</a>    def thaw(self, *args):
        &quot;&quot;&quot;
        Thaw plama properties.

        This method thaws (unfreezes) plasma properties allowing them to be
        updated again.

        Parameters
        ----------
        args : iterable of str
            Names of plasma properties to unfreeze.

        Examples
        --------
        &gt;&gt;&gt; plasma.thaw(&#39;t_electrons&#39;)
        &quot;&quot;&quot;
        for key in args:
            if key not in self.outputs_dict:
                raise PlasmaMissingModule(
                    &quot;Trying to thaw property {0}&quot;
                    &quot; that is unavailable&quot;.format(key)
                )
            self.outputs_dict[key].frozen = False</div>

    def _update_module_type_str(self):
        for node in self.graph:
            self.outputs_dict[node]._update_type_str()

    def _resolve_update_list(self, changed_properties):
        &quot;&quot;&quot;
        Returns a list of all plasma models which are affected by the
        changed_modules due to there dependency in the
        the plasma_graph.

        Parameters
        ----------
        changed_modules : list
            all modules changed in the plasma

        Returns
        -------
            : list
            all affected modules.
        &quot;&quot;&quot;

        descendants_ob = []

        for plasma_property in changed_properties:
            node_name = self.outputs_dict[plasma_property].name
            descendants_ob += nx.descendants(self.graph, node_name)

        descendants_ob = list(set(descendants_ob))
        sort_order = list(nx.topological_sort(self.graph))

        descendants_ob.sort(key=lambda val: sort_order.index(val))

        logger.debug(
            f&quot;Updating modules in the following order:&quot;
            f&#39;{&quot;-&gt;&quot;.join(descendants_ob)}&#39;
        )

        return descendants_ob

<div class="viewcode-block" id="BasePlasma.write_to_dot"><a class="viewcode-back" href="../../../api/tardis.plasma.base.html#tardis.plasma.base.BasePlasma.write_to_dot">[docs]</a>    def write_to_dot(self, fname, args=None, latex_label=True):
        &quot;&quot;&quot;
        This method takes the NetworkX Graph generated from the _build_graph
        method, converts it into a DOT code, and saves it to a file

        Parameters
        ----------
        fname: str
            the name of the file the graph will be saved to
        args: list
            a list of optional settings for displaying the
            graph written in DOT format
        latex_label: boolean
            enables/disables writing LaTeX equations and
            edge labels into the file.
        &quot;&quot;&quot;

        try:
            import pygraphviz
        except:
            logger.warn(
                &quot;pygraphviz missing. Plasma graph will not be &quot; &quot;generated.&quot;
            )
            return
        print_graph = self.graph.copy()
        print_graph = self.remove_hidden_properties(print_graph)

        for node in print_graph:
            if latex_label:
                if hasattr(self.plasma_properties_dict[node], &quot;latex_formula&quot;):
                    print_graph.nodes[str(node)][
                        &quot;label&quot;
                    ] = f&quot;\\\\textrm{{{node}: }}&quot;
                    node_list = self.plasma_properties_dict[node]
                    formulae = node_list.latex_formula
                    for output in range(0, len(formulae)):
                        formula = formulae[output]
                        label = formula.replace(&quot;\\&quot;, &quot;\\\\&quot;)
                        print_graph.nodes[str(node)][&quot;label&quot;] += label
                else:
                    print_graph.nodes[str(node)][
                        &quot;label&quot;
                    ] = f&quot;\\\\textrm{{{node}}}&quot;
            else:
                print_graph.nodes[str(node)][&quot;label&quot;] = node

        for edge in print_graph.edges:
            label = print_graph.edges[edge][&quot;label&quot;]
            print_graph.edges[edge][&quot;label&quot;] = &quot;-&quot;
            print_graph.edges[edge][&quot;texlbl&quot;] = label

        nx.drawing.nx_agraph.write_dot(print_graph, fname)

        for line in fileinput.FileInput(fname, inplace=1):
            if latex_label:
                print(
                    line.replace(
                        r&#39;node [label=&quot;\N&quot;]&#39;,
                        r&#39;node [texmode=&quot;math&quot;]&#39;,
                    ),
                    end=&quot;&quot;,
                )
            else:
                print(
                    line.replace(
                        r&#39;node [label=&quot;\N&quot;];&#39;,
                        &quot;&quot;,
                    ),
                    end=&quot;&quot;,
                )

        if args is not None:
            with open(fname, &quot;r&quot;) as file:
                lines = file.readlines()

            for newline in args:
                lines.insert(1, f&quot;\t{newline};\n&quot;)

            with open(fname, &quot;w&quot;) as f:
                lines = &quot;&quot;.join(lines)
                f.write(lines)</div>

<div class="viewcode-block" id="BasePlasma.write_to_tex"><a class="viewcode-back" href="../../../api/tardis.plasma.base.html#tardis.plasma.base.BasePlasma.write_to_tex">[docs]</a>    def write_to_tex(self, fname_graph, scale=0.5, args=None, latex_label=True):
        &quot;&quot;&quot;
        This method takes the NetworkX Graph generated from the _build_graph
        method, converts it into a LaTeX friendly format,
        and saves it to a file

        Parameters
        ----------
        fname_graph: str
            the name of the file the graph will be saved to
        args: list
            a list of optional settings for displaying the
            graph written in DOT format
        scale: float
            a scaling factor to expand/contract the generated
            graph
        latex_label: boolean
            enables/disables writing LaTeX equations and
            edge labels into the file.
        &quot;&quot;&quot;
        try:
            import dot2tex
        except:
            logger.warn(
                &quot;dot2tex missing. Plasma graph will not be &quot; &quot;generated.&quot;
            )
            return

        temp_fname = tempfile.NamedTemporaryFile().name

        self.write_to_dot(temp_fname, args=args, latex_label=latex_label)

        with open(temp_fname, &quot;r&quot;) as file:
            dot_string = file.read().replace(&quot;\\\\&quot;, &quot;\\&quot;)

        texcode = dot2tex.dot2tex(
            dot_string, format=&quot;tikz&quot;, crop=True, valignmode=&quot;dot&quot;
        )

        with open(fname_graph, &quot;w&quot;) as file:
            file.write(texcode)

        for line in fileinput.input(fname_graph, inplace=1):
            print(
                line.replace(
                    r&quot;\documentclass{article}&quot;,
                    r&quot;\documentclass[class=minimal,border=20pt]{standalone}&quot;,
                ),
                end=&quot;&quot;,
            )

        for line in fileinput.input(fname_graph, inplace=1):
            print(line.replace(r&quot;\enlargethispage{100cm}&quot;, &quot;&quot;), end=&quot;&quot;)

        for line in fileinput.input(fname_graph, inplace=1):
            print(
                line.replace(
                    r&quot;\begin{tikzpicture}[&gt;=latex&#39;,line join=bevel,]&quot;,
                    r&quot;\begin{tikzpicture}&quot;
                    r&quot;[&gt;=latex&#39;,line join=bevel,&quot;
                    fr&quot;scale={scale}]&quot;,
                ),
                end=&quot;&quot;,
            )</div>

<div class="viewcode-block" id="BasePlasma.remove_hidden_properties"><a class="viewcode-back" href="../../../api/tardis.plasma.base.html#tardis.plasma.base.BasePlasma.remove_hidden_properties">[docs]</a>    def remove_hidden_properties(self, print_graph):
        for item in self.plasma_properties_dict.values():
            module = self.plasma_properties_dict[item.name].__class__
            if issubclass(module, HiddenPlasmaProperty):
                output = module.outputs[0]
                for value in self.plasma_properties_dict.keys():
                    if output in getattr(
                        self.plasma_properties_dict[value], &quot;inputs&quot;, []
                    ):
                        for input in self.plasma_properties_dict[
                            item.name
                        ].inputs:
                            try:
                                position = self.outputs_dict[
                                    input
                                ].outputs.index(input)
                                label = self.outputs_dict[input].latex_name[
                                    position
                                ]
                                label = &quot;$&quot; + label + &quot;$&quot;
                                label = label.replace(&quot;\\&quot;, &quot;\\\\&quot;)
                            except:
                                label = input.replace(&quot;_&quot;, &quot;-&quot;)
                            self.graph.add_edge(
                                self.outputs_dict[input].name,
                                value,
                                label=label,
                            )
                print_graph.remove_node(str(item.name))
        return print_graph</div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2022, TARDIS Collaboration.
      <span class="lastupdated">Last updated on 24 Apr 2022.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>